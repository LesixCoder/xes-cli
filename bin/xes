#!/usr/bin/env node
const command = require("commander");
const figlet = require('figlet');
const Printer = require('@darkobits/lolcatjs');
const chalk = require('chalk');
const inquirer = require('inquirer');
const shelljs = require('shelljs');
const ora = require('ora');
const json2ts = require("json2ts");
const download = require("download-git-repo");

const pkg = require('../package')
const versionText = figlet.textSync('XES');

// é¡¹ç›®æ¨¡æ¿
const template = "direct:https://github.com/lsxlsxxslxsl/vue-standard-template.git";

command.version(Printer.default.fromString(`${versionText}\nauthor: liusixin<fordreamxkhl@gmail.com>\nversion: ${pkg.version}`), "-v, --version");
command.option("-i, --init", "åˆå§‹åŒ–é¡¹ç›®");

const bindHandler = {
  init (otherParams) {
    console.log("è¿›å…¥åˆå§‹åŒ–èŠ‚ç‚¹...");
    inquirer
      .prompt([
        {
          type: "text",
          message: "1ï¸âƒ£ è¯·è¾“å…¥æ–‡ä»¶å¤¹çš„åç§°",
          name: "dirname"
        },
        {
          type: "list",
          name: "jskind",
          message: "2ï¸âƒ£  è¯·é€‰æ‹©ä½¿ç”¨è¯­è¨€",
          choices: ["âœ” TypeScript", "âœ” EcmaScript6"]
        }
      ])
      .then(answers => {
        console.log("è·å–åˆ°ç”¨æˆ·è¾“å…¥", answers);
        const _pwddir = shelljs.pwd().stdout;
        const projectPath = `${_pwddir}/${answers.dirname}`;
        console.log("ç”¨æˆ·çš„å…¨è·¯å¾„", projectPath);
        shelljs.rm("-rf", projectPath);
        shelljs.mkdir(projectPath);
        const spinner = ora('downloading template....');
        spinner.start();
        download(template, projectPath, { clone: true }, err => {
          spinner.stop();
          if (err) {
            console.log("ä¸‹è½½å¤±è´¥");
          } else {
            shelljs.sed("-i", "vue-standard-template", answers.dirname, projectPath + "/package.json");
            console.log(chalk.green("ğŸ‘©â€âœˆï¸é¡¹ç›®åˆ›å»ºæˆåŠŸEnjoy Development"));
          }
        })
      }).catch(function (error) {
        console.log("ğŸ‘©â€âœˆï¸xes-cliå¯åŠ¨å¼‚å¸¸");
      });
  },
  js2ts (otherParams) {
    const testData = {
      name: "liusixin",
      data: {
        age: 30
      }
    }
    const jsonContent = JSON.stringify(testData);
    let result = json2ts.convert(jsonContent);
    console.log(result);
  }
};
command.usage("[cmd] <options>")
  //init å’Œinitä¸ä¸€æ ·
  .arguments("<cmd> [env]")
  .action(function (cmd, otherParams) {
    const handler = bindHandler[cmd];
    if (typeof handler === "undefined") {
      console.error(chalk.yellow('æŠ±æ­‰ï¼Œ') + chalk.red(cmd) + chalk.yellow(' æš‚æœªå®ç°'));
    } else {
      handler(otherParams);
    }
  });

command.parse(process.argv);
